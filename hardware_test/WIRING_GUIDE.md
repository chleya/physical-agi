# 连线检测指南

## ⚠️ 重要：通电前检查清单

在给硬件上电之前，**必须**运行连线检测：

```bash
python wire_check.py --port COM3
```

---

## 连线图

### 整体布局

```
┌─────────────────────────────────────────────────────────────┐
│                        俯视图                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│    ┌──────────────┐      ┌──────────────┐                 │
│    │   STM32F4    │      │    ESP32     │                 │
│    │   开发板     │      │   模块       │                 │
│    │              │      │              │                 │
│    │  PA2 ────────┼──────┤ GPIO17 (RX) │ ← 白线 (TX→RX)  │
│    │  PA3 ────────┼──────┤ GPIO16 (TX) │ ← 黄线 (RX→TX)  │
│    │              │      │              │                 │
│    │  PD4 ────────┼──────┤ GPIO0  (Boot)│ ← 蓝线         │
│    │  PD5 ────────┼──────┤ EN    (RST)  │ ← 紫线         │
│    │              │      │              │                 │
│    │  PB6 ────────┼──────┤              │                 │
│    │  PB7 ────────┼──────┤              │                 │
│    │              │      │              │                 │
│    │  PE0 ──┐     │      │              │                 │
│    │  PE1 ──┼─────┼──────┤              │                 │
│    │  PE2 ──┤     │      │              │                 │
│    │  PE3 ──┘     │      │              │                 │
│    │              │      │              │                 │
│    │  3.3V ───────┼──────┤ 3.3V        │ ← 红线         │
│    │  GND  ───────┼──────┤ GND         │ ← 黑线         │
│    │              │      │              │                 │
│    └──────┬───────┘      └──────┬───────┘                 │
│           │                      │                          │
│    ┌──────┴───────┐      ┌──────┴───────┐                 │
│    │  DRV8833     │      │   MPU6050    │                 │
│    │  电机驱动    │      │   IMU        │                 │
│    │              │      │              │                 │
│    │ VMOT ─── BATTERY (7.4V 锂电池)                       │
│    │ GND  ─── GND                                         │
│    │              │      │              │                 │
│    │ AIN1 ← PE0  │      │ VCC ── 3.3V  │ ← 红线         │
│    │ AIN2 ← PE1  │      │ GND ── GND   │ ← 黑线         │
│    │ BIN1 ← PE2  │      │ SCL ── PB6   │ ← 蓝线         │
│    │ BIN2 ← PE3  │      │ SDA ── PB7   │ ← 绿线         │
│    │              │      │ AD0 ── GND   │ ← 黑线         │
│    │ AOUT1 → M_L │      │              │                 │
│    │ AOUT2 → M_L │                                             │
│    │ BOUT1 → M_R │                                             │
│    │ BOUT2 → M_R │                                             │
│    └──────────────┘      └──────────────┘                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 详细连线表

### 1. UART 通信 (STM32 ↔ ESP32)

| 功能 | STM32 引脚 | ESP32 引脚 | 颜色 | 注意事项 |
|------|-----------|-----------|------|---------|
| TX → RX | PA2 | GPIO17 | 白色 | TX → RX **交叉** |
| RX ← TX | PA3 | GPIO16 | 黄色 | RX ← TX **交叉** |
| GND | GND | GND | 黑色 | 必须连接 |

⚠️ **关键**: TX 接 RX，RX 接 TX！

### 2. ESP32 控制

| 功能 | STM32 引脚 | ESP32 引脚 | 颜色 |
|------|-----------|-----------|------|
| BOOT 模式 | PD4 | GPIO0 | 蓝色 |
| 复位 | PD5 | EN | 紫色 |

### 3. I2C (MPU6050 IMU)

| 功能 | STM32 引脚 | MPU6050 引脚 | 颜色 |
|------|-----------|-------------|------|
| SCL | PB6 | SCL | 蓝色 |
| SDA | PB7 | SDA | 绿色 |
| VCC | 3.3V | VCC | 红色 |
| GND | GND | GND | 黑色 |
| AD0 | GND | AD0 | 黑色 |

### 4. 电机驱动 (DRV8833)

| 功能 | STM32 引脚 | DRV8833 引脚 | 颜色 |
|------|-----------|-------------|------|
| 左电机 PWM1 | PE0 | AIN1 | 绿色 |
| 左电机 PWM2 | PE1 | AIN2 | 橙色 |
| 右电机 PWM1 | PE2 | BIN1 | 黄色 |
| 右电机 PWM2 | PE3 | BIN2 | 棕色 |
| 电机电源 | BATTERY | VMOT | 红+黑 |
| 电机地 | GND | GND | 黑色 |

### 5. 电源

| 功能 | 电压 | 连接 |
|------|------|------|
| 主控 3.3V | 3.3V | STM32 3.3V → ESP32 3.3V → MPU6050 VCC |
| 主控地 | 0V | 所有 GND 连在一起 |
| 电池 | 7.4V (2S LiPo) | DRV8833 VMOT |
| 电池 | 3.7V (充满 4.2V) | STM32 VBAT (可选) |

---

## 常见连线错误

### ❌ 错误1: UART TX 接 TX

```
错误: PA2 (TX) ─── GPIO17 (TX)  ❌
```

**后果**: 无法通信

**正确**:
```
PA2 (TX) ─── GPIO17 (RX)  ✅
PA3 (RX) ─── GPIO16 (TX)  ✅
```

### ❌ 错误2: 电源反接

```
错误: 电池正负接反  ❌
```

**后果**: 烧毁芯片！

**正确**: 
- 红色 = 正极
- 黑色 = 负极
- **永远先接负极，再接正极**

### ❌ 错误3: I2C 地址错误

```
错误: MPU6050 AD0 悬空  ⚠️
```

**后果**: 地址可能是 0x68 或 0x69，不确定

**正确**: AD0 必须接地 (地址 0x68)

### ❌ 错误4: 电机线松动

```
错误: 电机端子松动  ⚠️
```

**后果**: 电机不转或抖动

**正确**: 确保端子插紧

---

## 检测命令

### 手动检测命令

```bash
# 测试串口
python -c "import serial; s=serial.Serial('COM3',115200); print(s.readline())"

# 发送命令
echo "VERSION" > COM3
```

### 检测结果解读

| 结果 | 含义 | 行动 |
|------|------|------|
| ✅ PASS | 连线正确 | 可以上电测试 |
| ⚠️ WARN | 可能有问题 | 检查备注信息 |
| ❌ FAIL | 连线错误 | 根据提示修复 |

---

## 上电前最终检查

```
□ 所有 GND 连在一起
□ 电源线颜色正确 (红=正, 黑=负)
□ UART 交叉连接 (TX→RX, RX→TX)
□ I2C 地址正确 (AD0=GND → 0x68)
□ 电机线牢固
□ 电池电压正常 (3.7V ~ 4.2V)
□ 没有裸露导线短路
□ 运行 wire_check.py 通过
```

---

## 故障排除

### 问题: 串口无响应

1. 检查 COM 端口是否正确
2. 检查 USB 线是否支持数据传输
3. 检查 BOOT 跳帽位置
4. 确认波特率 (115200)

### 问题: IMU 检测失败

1. 检查 VCC (3.3V)
2. 检查 GND
3. 检查 SCL/SDA 连线
4. 确认 AD0 接地

### 问题: 电机不转

1. 检查电池电压
2. 检查 IN1/IN2 连线
3. 检查电机端子
4. 确认 DRV8833 供电

---

最后更新: 2026-02-18
