# ç¡¬ä»¶è‡ªåŠ¨åŒ–æµ‹è¯•æ¡†æ¶

## æ¦‚è¿°

æœ¬æ¡†æ¶å®ç°"ç¡¬ä»¶ä¸€æ’ä¸Šç”µè„‘ï¼ŒOpenOCD ç›´æ¥å¸®æˆ‘æµ‹è¯•å®Œ"çš„æ„¿æ™¯ã€‚

## å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
pip install pyserial pandas
```

### 2. å®‰è£…å·¥å…·

- **OpenOCD**: ç”¨äº STM32 çƒ§å½•
  - ä¸‹è½½: https://github.com/openocd-org/openocd/releases
  - æ·»åŠ åˆ° PATH æˆ–æŒ‡å®š `--openocd_path`

- **esptool**: ç”¨äº ESP32 çƒ§å½•
  ```bash
  pip install esptool
  ```

### 3. è¿æ¥ç¡¬ä»¶

```
USB â†” ESP32 (COMx) â†” STM32 (COMy)
```

### 4. è¿è¡Œæµ‹è¯•

#### æ–¹å¼ 1: åŒå‡»è¿è¡Œ (æ¨è)

```bash
run_full_test.bat
```

#### æ–¹å¼ 2: å‘½ä»¤è¡Œ

```bash
# å®Œæ•´æµ‹è¯•
python hardware_auto_test.py --id 01

# å¿«é€Ÿæµ‹è¯• (è·³è¿‡éƒ¨åˆ†æµ‹è¯•)
python hardware_auto_test.py --id 01 --mode quick

# æŒ‡å®šç«¯å£
python hardware_auto_test.py --stm32_port COM3 --esp32_port COM4
```

#### æ–¹å¼ 3: æ‰¹é‡æµ‹è¯•

```bash
# åˆ›å»ºè®¾å¤‡åˆ—è¡¨
echo 01,COM3,COM4,Desk > devices.txt
echo 02,COM5,COM6,Shelf >> devices.txt

# æ‰¹é‡æµ‹è¯•
python hardware_auto_test.py --batch devices.txt
```

## ç›®å½•ç»“æ„

```
hardware_test/
â”œâ”€â”€ hardware_auto_test.py   # ä¸»æµ‹è¯•æ¡†æ¶
â”œâ”€â”€ wire_check.py          # âš ï¸ è¿çº¿æ£€æµ‹ (é€šç”µå‰å¿…ç”¨)
â”œâ”€â”€ realtime_monitor.py     # å®æ—¶æ•°æ®ç›‘æ§
â”œâ”€â”€ video_capture.py       # è§†é¢‘å½•åˆ¶
â”œâ”€â”€ data_analyzer.py       # æ•°æ®åˆ†æ
â”œâ”€â”€ run_full_dev_workflow.bat  # å®Œæ•´å·¥ä½œæµ
â”‚
â”œâ”€â”€ run_full_test.bat      # ä¸€é”®æµ‹è¯•è„šæœ¬
â”œâ”€â”€ openocd_stm32f4.cfg    # STM32 OpenOCD é…ç½®
â”œâ”€â”€ openocd_esp32.cfg      # ESP32 OpenOCD é…ç½®
â”œâ”€â”€ batch_flash.bat        # æ‰¹é‡çƒ§å½•è„šæœ¬
â”œâ”€â”€ stm32_wire_check.c     # STM32 è¿çº¿æ£€æµ‹å›ºä»¶
â”œâ”€â”€ stm32_self_test.c      # STM32 è‡ªæ£€å›ºä»¶
â”œâ”€â”€ SERIAL_PROTOCOL.md     # ä¸²å£é€šä¿¡åè®®
â”œâ”€â”€ WIRING_GUIDE.md       # è¿çº¿æŒ‡å—
â”œâ”€â”€ devices.txt.example    # è®¾å¤‡åˆ—è¡¨ç¤ºä¾‹
â””â”€â”€ README.md              # æœ¬æ–‡æ¡£
```

## âš ï¸ è¿çº¿æ£€æµ‹ (å¿…è¯»!)

åœ¨ç»™ç¡¬ä»¶ä¸Šç”µä¹‹å‰ï¼Œ**å¿…é¡»**å…ˆæ£€æµ‹è¿çº¿ï¼

```bash
# åŸºæœ¬æ£€æµ‹
python wire_check.py --port COM3

# æ˜¾ç¤ºè¯¦ç»†ä¿®å¤å»ºè®®
python wire_check.py --port COM3 --auto-fix

# åªæ˜¾ç¤ºè¿çº¿å›¾
python wire_check.py --diagram
```

### æ£€æµ‹é¡¹ç›®

| æ£€æµ‹é¡¹ | è¯´æ˜ |
|--------|------|
| ä¸²å£è¿æ¥ | æ£€æµ‹ COM ç«¯å£æ˜¯å¦å¯è®¿é—® |
| STM32 é€šä¿¡ | æ£€æµ‹ STM32 æ˜¯å¦å“åº” |
| ESP32 é€šä¿¡ | æ£€æµ‹ ESP32 æ˜¯å¦æ­£å¸¸ |
| IMU (MPU6050) | æ£€æµ‹ I2C è®¾å¤‡ |
| ç”µæœºé©±åŠ¨ (DRV8833) | æ£€æµ‹ PWM è¾“å‡º |
| ç”µæ± ç”µå‹ | æ£€æµ‹ç”µæºçŠ¶æ€ |
| UART å›ç¯ | æ£€æµ‹ TX/RX äº¤å‰è¿æ¥ |

### å¸¸è§é”™è¯¯

| é”™è¯¯ | ç—‡çŠ¶ | ä¿®å¤ |
|------|------|------|
| UART TX æ¥ TX | ä¸²å£æ— å“åº” | äº¤å‰è¿æ¥ |
| ç”µæºåæ¥ | èŠ¯ç‰‡å‘çƒ­ | æ£€æŸ¥çº¢é»‘çº¿ |
| I2C æµ®åŠ¨ | IMU è¯»ä¸åˆ° | AD0 æ¥åœ° |
| ç”µæœºçº¿æ¾åŠ¨ | ç”µæœºä¸è½¬ | æ’ç´§ç«¯å­ |

---

## å®æ—¶ç›‘æ§

### æµ‹è¯•æµç¨‹

```
1. çƒ§å½• STM32 (OpenOCD)
2. çƒ§å½• ESP32 (esptool)
3. ç­‰å¾…è®¾å¤‡å¯åŠ¨
4. ç¡¬ä»¶è‡ªæ£€
   - IMU æµ‹è¯•
   - ç”µæœºæµ‹è¯•
   - ESP32 é€šä¿¡æµ‹è¯•
   - ç”µæ± ç”µå‹æµ‹è¯•
5. NCA æ¨ç†æµ‹è¯•
6. ç”ŸæˆæŠ¥å‘Š (HTML + CSV)
```

### æµ‹è¯•é¡¹ç›®

| é¡¹ç›® | è¯´æ˜ | å¿…éœ€ |
|------|------|------|
| STM32 çƒ§å½• | OpenOCD çƒ§å½•å›ºä»¶ | âœ… |
| ESP32 çƒ§å½• | esptool çƒ§å½•å›ºä»¶ | âœ… |
| IMU æµ‹è¯• | MPU6050 æ•°æ®è¯»å– | âœ… |
| ç”µæœºæµ‹è¯• | ç”µæœºè½¬åŠ¨æµ‹è¯• | âœ… |
| ESP32 é€šä¿¡ | STM32 â†” ESP32 é€šä¿¡ | âœ… |
| ç”µæ± æµ‹è¯• | ç”µå‹æ£€æµ‹ | âœ… |
| NCA æ¨ç† | ç¥ç»ç½‘ç»œæ¨ç† | â­ï¸ |

## è¾“å‡ºæŠ¥å‘Š

### æŠ¥å‘Šä½ç½®

```
reports/
â”œâ”€â”€ device_01_20260218_153045/
â”‚   â”œâ”€â”€ report.json          # è¯¦ç»†æ•°æ®
â”‚   â”œâ”€â”€ report.html          # å¯è§†åŒ–æŠ¥å‘Š
â”‚   â””â”€â”€ summary.csv          # æ‘˜è¦è¡¨æ ¼
â””â”€â”€ device_02_20260218_160120/
    â””â”€â”€ ...
```

### HTML æŠ¥å‘Šç¤ºä¾‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ§ª ç¡¬ä»¶æµ‹è¯•æŠ¥å‘Š                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ çŠ¶æ€: âœ… PASS                        â”‚
â”‚                                     â”‚
â”‚ è®¾å¤‡ID: 01                          â”‚
â”‚ ä½ç½®: Desk                          â”‚
â”‚ æ—¶é—´: 2026-02-18 15:30:45           â”‚
â”‚ æ—¶é•¿: 4523ms                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æµ‹è¯•ç»“æœ                             â”‚
â”‚ âœ… STM32 çƒ§å½•: é€šè¿‡                  â”‚
â”‚ âœ… ESP32 çƒ§å½•: é€šè¿‡                  â”‚
â”‚ âœ… IMU æµ‹è¯•: é€šè¿‡                    â”‚
â”‚ âœ… ç”µæœºæµ‹è¯•: é€šè¿‡                    â”‚
â”‚ âœ… ESP32 é€šä¿¡: é€šè¿‡                  â”‚
â”‚ âœ… ç”µæ± æµ‹è¯•: é€šè¿‡                    â”‚
â”‚ âœ… NCA æ¨ç†: é€šè¿‡                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç”µæ± ç”µå‹: 3.85V                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## è‡ªå®šä¹‰é…ç½®

### ä¿®æ”¹é»˜è®¤ç«¯å£

ç¼–è¾‘ `hardware_auto_test.py`:

```python
# é»˜è®¤ç«¯å£
parser.add_argument('--stm32_port', default='COM3', ...)
parser.add_argument('--esp32_port', default='COM4', ...)
```

### æ·»åŠ æ–°æµ‹è¯•

```python
class HardwareTestFramework:
    
    def test_my_feature(self, device: DeviceConfig) -> Dict:
        """è‡ªå®šä¹‰æµ‹è¯•"""
        log('STEP', 'ğŸ“Š æµ‹è¯•æ–°åŠŸèƒ½...')
        
        # ä½ çš„æµ‹è¯•ä»£ç 
        
        return {'success': True}
    
    def run_full_test(self, device, mode='full'):
        # ... ç°æœ‰ä»£ç 
        
        # æ·»åŠ æ–°æµ‹è¯•
        if mode == 'full':
            self.test_my_feature(device)
```

## ä¸²å£é€šä¿¡åè®®

è¯¦è§ `SERIAL_PROTOCOL.md`

### åŸºæœ¬å‘½ä»¤

```bash
# è‡ªæ£€
SELF_TEST
# å“åº”: OK[IMU=1,MOTOR_L=1,MOTOR_R=1,ESP32=1,BAT=3.85]

# è·å–IMUæ•°æ®
GET_IMU
# å“åº”: OK[AX=100,AY=200,AZ=1000,...]

# æ§åˆ¶ç”µæœº
START_MOTOR 500 500    # å·¦500, å³500
STOP_MOTOR

# è·å–ç”µæ± 
GET_BATTERY
# å“åº”: OK[VOLTAGE=3850]
```

## æ•…éšœæ’é™¤

### OpenOCD æœªæ‰¾åˆ°

```bash
# æ–¹æ¡ˆ 1: æ·»åŠ åˆ° PATH
set PATH=%PATH%;C:\OpenOCD\bin

# æ–¹æ¡ˆ 2: æŒ‡å®šè·¯å¾„
python hardware_auto_test.py --openocd_path "C:\OpenOCD\bin\openocd.exe"
```

### ä¸²å£å ç”¨

```bash
# Windows: æŸ¥çœ‹ç«¯å£å ç”¨
mode

# å…³é—­å ç”¨ä¸²å£çš„ç¨‹åº
```

### çƒ§å½•å¤±è´¥

1. æ£€æŸ¥ USB è¿æ¥
2. ç¡®è®¤é©±åŠ¨å®‰è£…
3. æ£€æŸ¥ BOOT æ¨¡å¼
4. æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—

## é«˜çº§ç”¨æ³•

### åªçƒ§å½•ä¸æµ‹è¯•

```bash
python hardware_auto_test.py --id 01 --mode quick
```

### åªæµ‹è¯•ä¸çƒ§å½•

ä¿®æ”¹ä»£ç ï¼Œè·³è¿‡çƒ§å½•æ­¥éª¤ã€‚

### CI/CD é›†æˆ

```yaml
# GitHub Actions
- name: Hardware Test
  run: |
    python hardware_test/hardware_auto_test.py --id 01
    echo "Report: reports/device_01_*/report.html"
```

## æ‰©å±•åŠŸèƒ½

### è§†é¢‘å½•åˆ¶

éœ€è¦å®‰è£… FFmpeg:

```bash
# Windows
choco install ffmpeg

# Linux
sudo apt install ffmpeg
```

ç„¶åä¿®æ”¹ `run_full_test.bat`:

```batch
@echo å½•åˆ¶è§†é¢‘...
ffmpeg -f dshow -i video="Camera" -t 60 videos/test_01.mp4
```

### è¿œç¨‹ç›‘æ§

é€šè¿‡ MQTT ä¸ŠæŠ¥æµ‹è¯•ç»“æœ:

```python
def mqtt_report(result):
    client.publish("nca-mesh/test/result", json.dumps(result.to_dict()))
```

---

## ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´ |
|------|------|------|
| v1.0 | 2026-02-18 | åˆå§‹ç‰ˆæœ¬ |

---

æœ€åæ›´æ–°: 2026-02-18
